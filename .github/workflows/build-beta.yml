name: Build Beta/RC Release

on:
  push:
    tags:
      - 'v*-beta*'   # Ex: v10.0.11-beta, v10.0.11-beta2
      - 'v*-rc*'     # Ex: v10.0.11-rc1, v10.0.11-rc2
      - 'v*-alpha*'  # Ex: v10.0.11-alpha

jobs:
  build-windows-beta:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: desktop_app/package-lock.json
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r blog_pos/requirements.txt
          pip install pyinstaller
      
      - name: Collect static files
        run: |
          cd blog_pos
          python manage.py collectstatic --noinput
        env:
          DJANGO_SETTINGS_MODULE: blog_pos.settings
      
      - name: Build Django executable
        run: |
          python -c "import sys; print(f'Python: {sys.version}')"
          pyinstaller --clean DAMA_Server_ONEDIR.spec
      
      - name: Prepare Electron resources
        run: |
          # Copier l'ex√©cutable Django
          xcopy dist\DAMA_Django_Server desktop_app\resources\DAMA_Django_Server\ /E /I /Y
          
          # Copier les modules Django essentiels
          xcopy blog_pos\blog_pos desktop_app\resources\blog_pos\ /E /I /Y
          xcopy blog_pos\order desktop_app\resources\order\ /E /I /Y
          xcopy blog_pos\users desktop_app\resources\users\ /E /I /Y
          xcopy blog_pos\client desktop_app\resources\client\ /E /I /Y
          xcopy blog_pos\aprovision desktop_app\resources\aprovision\ /E /I /Y
          xcopy blog_pos\product desktop_app\resources\product\ /E /I /Y
          xcopy blog_pos\licensing desktop_app\resources\licensing\ /E /I /Y
        shell: powershell
      
      - name: Install Electron dependencies
        working-directory: desktop_app
        run: npm ci
      
      - name: Build Electron app
        working-directory: desktop_app
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.DISTRIBUTION_TOKEN }}
      
      - name: Upload to welto-distribution repo (PRERELEASE)
        uses: softprops/action-gh-release@v1
        with:
          repository: ${{ github.repository_owner }}/welto-distribution
          files: |
            desktop_app/dist/*.exe
            desktop_app/dist/*.yml
          draft: false
          prerelease: true
          generate_release_notes: true
          body: |
            ## ‚ö†Ô∏è WELTO POS - Version Beta/RC ${{ github.ref_name }}
            
            **ATTENTION** : Ceci est une version de test (beta/rc/alpha).
            
            ### ‚ö° Version de test - Pour validation uniquement
            Cette version n'est PAS distribu√©e automatiquement aux clients.
            Les mises √† jour automatiques ignoreront cette version.
            
            ### üì¶ Fichiers de distribution
            - `WELTO-Setup-${{ github.ref_name }}.exe` - Installateur Windows (TEST)
            - `WELTO-Portable.exe` - Version portable (TEST)
            - `latest.yml` - M√©tadonn√©es (ignor√©es par les clients en production)
            
            ### üß™ Installation pour test
            1. T√©l√©charger `WELTO-Setup-${{ github.ref_name }}.exe`
            2. Ex√©cuter l'installateur
            3. Tester toutes les fonctionnalit√©s
            4. Reporter les bugs ou valider pour release stable
            
            ### ‚úÖ Validation
            Si tous les tests passent, cr√©er le tag stable :
            ```bash
            git tag v[VERSION]
            git push origin v[VERSION]
            ```
            
            ---
            ¬© 2025 GABITHEX TEAM - D√©velopp√© par Aliou Diallo
        env:
          GITHUB_TOKEN: ${{ secrets.DISTRIBUTION_TOKEN }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: welto-windows-beta-${{ github.ref_name }}
          path: |
            desktop_app/dist/*.exe
          retention-days: 90
